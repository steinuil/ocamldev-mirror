# 1 "extlib/cpp.mll"
 
  
  let current_file = ref []
  let current_line = ref ""
  let current_pos = ref 0
  
  let abort () =
    let location = match !current_file with
        [] -> assert false
      | (_,filename,line,_)::_ -> Printf.sprintf " at %s:%d" filename !line
    in
    List.iter (fun (ic,_, _, _) -> close_in ic) !current_file;
    current_file := []; 
    current_line := "";
    location
  
  let failwith s = 
    let location = abort () in
    failwith (s^location)
  
  let path = ref []
  let maxstr = 100
  let strbuf = String.create maxstr
  let strlen = ref 0
  let add_char lexbuf =
    strbuf.[!strlen] <- Lexing.lexeme_char lexbuf 0;
    incr strlen;
    if !strlen = maxstr then failwith "String too long in cpp"


# 33 "extlib/cpp.ml"
let __ocaml_lex_tables = {
  Lexing.lex_base = 
   "\000\000\001\000\002\000\253\255\252\255\003\000\004\000\006\000\
    \005\000\008\000\009\000\011\000\007\000\012\000\010\000\254\255\
    \255\255";
  Lexing.lex_backtrk = 
   "\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\000\000\001\000\255\255\255\255\
    \255\255";
  Lexing.lex_default = 
   "\001\000\001\000\001\000\000\000\000\000\001\000\001\000\001\000\
    \001\000\001\000\001\000\001\000\001\000\001\000\003\000\000\000\
    \000\000";
  Lexing.lex_trans = 
   "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\003\000\003\000\003\000\003\000\003\000\003\000\
    \003\000\003\000\003\000\003\000\011\000\003\000\003\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\002\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\011\000\016\000\013\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\012\000\
    \016\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\007\000\
    \000\000\000\000\000\000\005\000\010\000\000\000\011\000\000\000\
    \000\000\006\000\008\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\009\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\
    \004\000\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\015\000\255\255\255\255";
  Lexing.lex_check = 
   "\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\000\000\001\000\002\000\005\000\006\000\008\000\
    \007\000\012\000\009\000\010\000\011\000\011\000\013\000\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\000\000\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\011\000\014\000\011\000\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\011\000\
    \014\000\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\006\000\
    \255\255\255\255\255\255\002\000\009\000\255\255\010\000\255\255\
    \255\255\005\000\007\000\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\008\000\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\255\
    \000\000\001\000\002\000\005\000\006\000\008\000\007\000\012\000\
    \009\000\010\000\014\000\011\000\013\000";
  Lexing.lex_base_code = 
   "";
  Lexing.lex_backtrk_code = 
   "";
  Lexing.lex_default_code = 
   "";
  Lexing.lex_trans_code = 
   "";
  Lexing.lex_check_code = 
   "";
  Lexing.lex_code = 
   "";
}

let rec next_line lexbuf =
    __ocaml_lex_next_line_rec lexbuf 0
and __ocaml_lex_next_line_rec lexbuf __ocaml_lex_state =
  match Lexing.engine __ocaml_lex_tables __ocaml_lex_state lexbuf with
      | 0 ->
# 33 "extlib/cpp.mll"
                               ( strlen:=0; include_file lexbuf )
# 138 "extlib/cpp.ml"

  | 1 ->
# 34 "extlib/cpp.mll"
                               ( strlen:=0; include_file lexbuf )
# 143 "extlib/cpp.ml"

  | 2 ->
# 35 "extlib/cpp.mll"
                    ( Lexing.lexeme lexbuf )
# 148 "extlib/cpp.ml"

  | 3 ->
# 36 "extlib/cpp.mll"
                    ( 
      match !current_file with
        [] -> assert false
      | [ic,_,_,_] -> close_in ic; ""
      | (ic,_,_,_) :: (((_,_,_,lexbuf) :: _) as file) ->
          close_in ic;
          current_file := file;
          next_line lexbuf
    )
# 161 "extlib/cpp.ml"

  | __ocaml_lex_state -> lexbuf.Lexing.refill_buff lexbuf; __ocaml_lex_next_line_rec lexbuf __ocaml_lex_state

and include_file lexbuf =
    __ocaml_lex_include_file_rec lexbuf 14
and __ocaml_lex_include_file_rec lexbuf __ocaml_lex_state =
  match Lexing.engine __ocaml_lex_tables __ocaml_lex_state lexbuf with
      | 0 ->
# 47 "extlib/cpp.mll"
              ( 
      let filename = String.sub strbuf 0 !strlen in
      let filename =
        try Filepath.find_in_path !path filename with _ ->
            failwith (Printf.sprintf "included file %s not found" filename)
      in
      let ic = open_in filename in
      let lexbuf = Lexing.from_channel ic in
      current_file := (ic,filename,ref 0,lexbuf) :: !current_file;
      next_line lexbuf
    )
# 182 "extlib/cpp.ml"

  | 1 ->
# 58 "extlib/cpp.mll"
        ( failwith "EOF in #include directive" )
# 187 "extlib/cpp.ml"

  | 2 ->
# 59 "extlib/cpp.mll"
      ( add_char lexbuf; include_file lexbuf )
# 192 "extlib/cpp.ml"

  | __ocaml_lex_state -> lexbuf.Lexing.refill_buff lexbuf; __ocaml_lex_include_file_rec lexbuf __ocaml_lex_state

;;

# 61 "extlib/cpp.mll"
 

let do_next_line buf maxlen =
  let len = String.length !current_line in
  if len - !current_pos = 0 then begin
      current_pos := 0;
      current_line := (match !current_file with
          [] -> assert false
        | (ic,_,line, lexbuf) :: _ -> incr line; next_line lexbuf);
    end;
  let len = String.length !current_line in
  let displen = len - !current_pos in
  if displen = 0 then 0 else
  let dolen = min maxlen displen in
  String.blit !current_line !current_pos buf 0 dolen;
  current_pos := !current_pos + dolen;
  dolen

let preprocess filename =
  let ic = open_in filename in
  current_file := [ic, filename, ref 0, Lexing.from_channel ic];
  Lexing.from_function do_next_line

# 222 "extlib/cpp.ml"
